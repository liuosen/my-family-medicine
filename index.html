<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ™ºèƒ½è¯ç®± (ç™¾ç§‘ç‰ˆ)</title>
    <script src="//cdn.jsdelivr.net/npm/leancloud-storage@4.15.0/dist/av-min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        :root { --primary: #10a37f; --primary-dark: #0d8a6c; --blue: #3b82f6; --danger: #d73a49; --warning: #f59e0b; --bg: #f3f4f6; --card: #fff; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); padding: 15px; color: #1f2937; margin: 0; padding-bottom: 80px; }
        .container { max-width: 800px; margin: 0 auto; display: none; }
        h2 { text-align: center; color: #374151; margin-bottom: 15px; font-weight: 700; }

        /* ç™»å½•æ¡† */
        #login-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 10000; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; }
        .pass-input { padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 18px; text-align: center; margin-bottom: 15px; outline: none; }
        .login-btn { padding: 12px 30px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 16px; }

        /* é¡¶éƒ¨ç­›é€‰ */
        .filter-section { position: sticky; top: 0; background: var(--bg); z-index: 90; padding: 10px 0; border-bottom: 1px solid #e5e7eb; }
        .search-box { position: relative; margin-bottom: 10px; }
        .search-box input { width: 100%; padding: 12px 15px 12px 40px; border: 1px solid #e5e7eb; border-radius: 25px; font-size: 16px; box-sizing: border-box; }
        .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #9ca3af; }
        .category-scroll { display: flex; overflow-x: auto; gap: 8px; padding-bottom: 8px; scrollbar-width: none; }
        .category-scroll::-webkit-scrollbar { display: none; }
        .cat-btn { white-space: nowrap; padding: 6px 16px; border-radius: 20px; border: 1px solid #e5e7eb; background: white; color: #4b5563; font-size: 14px; transition: all 0.2s; }
        .cat-btn.active { background: var(--primary); color: white; border-color: var(--primary); font-weight: 600; }
        .cat-btn.special { border-color: #fcd34d; color: #b45309; }
        .cat-btn.special.active { background: var(--warning); color: white; }

        /* ä¸»æ“ä½œæŒ‰é’®ç»„ */
        .main-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .action-card { background: white; padding: 15px; border-radius: 12px; text-align: center; font-weight: 600; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid #e5e7eb; color: #4b5563; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .action-card:active { transform: scale(0.98); background: #f9fafb; }
        .add-btn { color: var(--primary-dark); border-color: #a7f3d0; background: #ecfdf5; }
        .wiki-btn { color: #1e40af; border-color: #bfdbfe; background: #eff6ff; }

        /* è¯å“è¡¨å• */
        .input-card { background: var(--card); padding: 20px; border-radius: 16px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05); margin-bottom: 20px; display: none; position: relative; }
        .input-card.show { display: block; animation: slideDown 0.3s; }
        .form-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .full-width { grid-column: 1 / -1; }
        label { display: block; margin-bottom: 5px; font-size: 0.85em; font-weight: 600; color: #4b5563; }
        input, select { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; box-sizing: border-box; font-size: 15px; }
        
        /* æ ‡ç­¾ */
        .tags-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 5px; }
        .check-tag { padding: 6px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; cursor: pointer; background: #f9fafb; }
        .check-tag.checked { background: #ecfdf5; border-color: var(--primary); color: var(--primary-dark); font-weight: bold; }

        /* æŒ‰é’®æ ·å¼ */
        .btn { padding: 12px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; color: white; display: flex; justify-content: center; align-items: center; gap: 5px; }
        .btn-primary { background: var(--primary); width: 100%; }
        .btn-cancel { background: #9ca3af; width: 100%; }
        .btn-scan { background: #1f2937; color: white; padding: 8px 12px; border-radius: 6px; border:none; cursor: pointer; }
        .btn-ai { background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; padding: 8px 12px; border-radius: 6px; border:none; cursor: pointer; font-size: 13px; }

        /* è¯å“åˆ—è¡¨å¡ç‰‡ */
        .drug-card { background: var(--card); padding: 16px; margin-bottom: 12px; border-radius: 12px; border-left: 6px solid var(--primary); position: relative; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .drug-card.expired { border-left-color: var(--danger); background: #fef2f2; }
        .drug-card.warning { border-left-color: var(--warning); background: #fffbeb; }
        .card-actions { position: absolute; top: 12px; right: 12px; display: flex; gap: 8px; }
        .icon-btn { background: none; border: none; font-size: 18px; cursor: pointer; padding: 5px; color: #9ca3af; }
        .drug-name { font-size: 1.15em; font-weight: 700; margin: 0 0 5px 0; color: #111827; }
        .info-row { display: flex; gap: 10px; font-size: 0.85em; color: #6b7280; margin-bottom: 8px; align-items: center; }
        .mini-tag { font-size: 11px; padding: 2px 6px; border-radius: 4px; background: #e5e7eb; color: #374151; margin-right: 5px; }

        /* === ğŸ“– ç™¾ç§‘å¼¹çª—æ ·å¼ === */
        #wiki-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:3000; justify-content:center; align-items:flex-end; }
        .wiki-content { background: white; width: 100%; height: 85vh; border-radius: 20px 20px 0 0; padding: 20px; box-sizing: border-box; display: flex; flex-direction: column; animation: slideUp 0.3s; }
        .wiki-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .wiki-body { flex: 1; overflow-y: auto; line-height: 1.6; color: #374151; padding: 10px; background: #f9fafb; border-radius: 8px; border: 1px solid #eee; white-space: pre-wrap; font-size: 15px; }
        .wiki-input-group { display: flex; gap: 10px; margin-bottom: 10px; }
        .wiki-title { font-size: 1.2em; font-weight: bold; color: #3b82f6; }

        /* é€šç”¨é®ç½© */
        #scanner-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:4000; flex-direction:column; justify-content:center; }
        #loading-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:5000; justify-content:center; align-items:center; flex-direction:column; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s infinite linear; }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    </style>
</head>
<body>

<!-- ç™»å½• -->
<div id="login-modal">
    <div style="font-size:40px;margin-bottom:10px">ğŸ’Š</div>
    <h3 style="margin-top:0">å®¶åº­è¯ç®±</h3>
    <input type="password" id="passwordInput" class="pass-input" placeholder="è¾“å…¥å¯†ç " onkeyup="if(event.key==='Enter') checkLogin()">
    <button class="login-btn" onclick="checkLogin()">è¿›å…¥</button>
</div>

<!-- ğŸ“– è¯å“ç™¾ç§‘å¼¹çª— -->
<div id="wiki-modal">
    <div class="wiki-content">
        <div class="wiki-header">
            <span class="wiki-title">ğŸ“– è¯å“ç™¾ç§‘æŸ¥è¯¢</span>
            <button onclick="document.getElementById('wiki-modal').style.display='none'" style="border:none;background:none;font-size:24px;color:#999">Ã—</button>
        </div>
        <div class="wiki-input-group">
            <input type="text" id="wikiInput" placeholder="è¾“å…¥æƒ³äº†è§£çš„è¯åï¼ˆå¦‚ï¼šé˜¿è«è¥¿æ—ï¼‰" style="flex:1">
            <button class="btn-ai" onclick="searchWiki()" style="width:auto;padding:0 20px">æŸ¥è¯¢</button>
        </div>
        <div id="wikiResult" class="wiki-body">
            <div style="color:#999;text-align:center;margin-top:50px">
                è¾“å…¥è¯å“åç§°ï¼ŒAI å°†ä¸ºæ‚¨ç”Ÿæˆ<br>è¯¦ç»†çš„åŠŸèƒ½ã€ç”¨æ³•ã€ç¦å¿Œè¯´æ˜ä¹¦ã€‚<br><br>ğŸ’¡ å³ä½¿è¯ç®±é‡Œæ²¡æœ‰çš„è¯ä¹Ÿèƒ½æŸ¥ï¼
            </div>
        </div>
    </div>
</div>

<!-- æ‰«ç  -->
<div id="scanner-modal">
    <div style="position:absolute;top:20px;right:20px;color:white;font-size:30px;cursor:pointer" onclick="stopScanner()">Ã—</div>
    <div id="reader" style="width:100%;max-width:500px"></div>
</div>

<!-- Loading -->
<div id="loading-overlay">
    <div class="spinner"></div>
    <div id="loading-text" style="margin-top:15px;color:#666">åŠ è½½ä¸­...</div>
</div>

<div class="container" id="mainApp">
    <h2>ğŸ¥ æ™ºèƒ½å®¶åº­è¯ç®±</h2>

    <!-- 1. é¡¶éƒ¨ç­›é€‰ -->
    <div class="filter-section">
        <div class="search-box">
            <span class="search-icon">ğŸ”</span>
            <input type="text" id="searchInput" placeholder="æœç´¢æˆ‘çš„åº“å­˜..." oninput="handleSearch()">
        </div>
        <div class="category-scroll" id="filterBar">
            <button class="cat-btn active" onclick="filterBy('all', this)">å…¨éƒ¨</button>
            <button class="cat-btn special" onclick="filterBy('expired', this)">âš ï¸ å·²è¿‡æœŸ</button>
            <button class="cat-btn special" onclick="filterBy('expiring', this)">â³ å¿«è¿‡æœŸ</button>
            <!-- æ ‡ç­¾å°†é€šè¿‡JSç”Ÿæˆ -->
        </div>
    </div>

    <!-- 2. ä¸»åŠŸèƒ½æŒ‰é’®åŒº (æ”¹ç‰ˆ) -->
    <div class="main-actions">
        <div class="action-card add-btn" onclick="openForm()">
            <span>â• æ·»åŠ /æ‰«ç è¯å“</span>
        </div>
        <div class="action-card wiki-btn" onclick="openWiki()">
            <span>ğŸ“– æŸ¥è¯å“ç™¾ç§‘</span>
        </div>
    </div>
    
    <!-- 3. æ·»åŠ /ç¼–è¾‘è¡¨å• -->
    <div class="input-card" id="inputCard">
        <h3 style="margin-top:0;margin-bottom:15px;color:#374151" id="formTitle">æ·»åŠ è¯å“</h3>
        <div class="form-grid">
            <div class="full-width" style="display:flex;gap:8px">
                <div style="flex:1">
                    <label>åç§° / æ¡ç </label>
                    <input type="text" id="name" placeholder="åç§° æˆ– æ‰«ç ">
                </div>
                <div style="display:flex;align-items:flex-end;gap:5px">
                    <button class="btn-scan" onclick="startScanner()">ğŸ“·</button>
                    <button class="btn-ai" onclick="identifyDrug()">âœ¨ å¡«å•</button>
                </div>
            </div>
            <div class="full-width">
                <label>åŠŸèƒ½æ ‡ç­¾</label>
                <div class="tags-container" id="tagSelectionArea"></div>
            </div>
            <div><label>æœ‰æ•ˆæœŸ</label><input type="date" id="expiry"></div>
            <div><label>åº“å­˜</label><input type="text" id="quantity"></div>
            <div><label>äººç¾¤</label><select id="target"><option>é€šç”¨</option><option>æˆäºº</option><option>å„¿ç«¥</option><option>è€äºº</option></select></div>
            <div><label>æ€§åˆ«</label><select id="gender"><option>é€šç”¨</option><option>ç”·æ€§</option><option>å¥³æ€§</option></select></div>
            <div class="full-width"><label>ä¸»æ²»</label><input type="text" id="usage"></div>
            <div class="full-width"><label>ç”¨æ³•</label><input type="text" id="dosage"></div>
            <div class="full-width"><label>æ³¨æ„</label><input type="text" id="notes" style="border-color:#fecaca"></div>
        </div>
        <div style="display:flex;gap:10px;margin-top:20px">
            <button class="btn btn-cancel" onclick="closeForm()">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="saveDrug()" id="saveBtn">ä¿å­˜</button>
        </div>
    </div>

    <!-- 4. åˆ—è¡¨åŒº -->
    <div id="drugList"></div>
</div>

<script>
    // ================== é…ç½®åŒº ==================
     const USER_PASSWORD = "285925";  // è®¾ç½®ä½ çš„å®¶åº­å¯†ç 
    const LC_APP_ID = 'WebkPZV6qkXf2ILVmohQlIj7-gzGzoHsz';
    const LC_APP_KEY = 'pD4b4TdG7tEFioQBXOMbWWi6';
    const AI_API_KEY = 'sk-69074729a1fa403789c054d21d450d6f';

    const TAG_LIST = ["æ¶ˆç‚", "æ„Ÿå†’å‘çƒ§", "å’³å—½å’½ç—›", "æ­¢ç—›", "æ¶ˆåŒ–", "çš®è‚¤", "é«˜è¡€å‹", "å…³èŠ‚ç—›", "å¤–ç”¨", "æŠ—è¿‡æ•", "ç»´ç”Ÿç´ ", "å„¿ç«¥ä¸“ç”¨"];
    // ===========================================

    let allDrugsCache = [];
    let currentEditingId = null;
    let html5QrCode;

    // --- åˆå§‹åŒ– ---
    function init() {
        if(!LC_APP_ID.includes('AppID')) {
            AV.init({ appId: LC_APP_ID, appKey: LC_APP_KEY, serverURL: "https://ulnxpw1a.lc-cn-n1-shared.com" });
        }
        initTagsUI();
    }

    function initTagsUI() {
        const filterBar = document.getElementById('filterBar');
        const tagArea = document.getElementById('tagSelectionArea');
        TAG_LIST.forEach(tag => {
            // ç­›é€‰æ 
            const btn = document.createElement('button');
            btn.className = 'cat-btn';
            btn.innerText = tag;
            btn.onclick = function() { filterBy(tag, this) };
            filterBar.appendChild(btn);
            // è¡¨å•é€‰æ‹©
            const span = document.createElement('span');
            span.className = 'check-tag';
            span.innerText = tag;
            span.onclick = function() { this.classList.toggle('checked'); };
            tagArea.appendChild(span);
        });
    }

    function checkLogin() {
        if(document.getElementById('passwordInput').value === USER_PASSWORD) {
            document.getElementById('login-modal').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            init();
            fetchDrugs();
        } else { alert("å¯†ç é”™è¯¯"); }
    }

    // --- ğŸ“– è¯å“ç™¾ç§‘æŸ¥è¯¢é€»è¾‘ (æ ¸å¿ƒæ–°åŠŸèƒ½) ---
    function openWiki() {
        document.getElementById('wiki-modal').style.display = 'flex';
        document.getElementById('wikiInput').focus();
    }

    async function searchWiki() {
        const name = document.getElementById('wikiInput').value.trim();
        if(!name) return alert("è¯·è¾“å…¥è¯å");
        
        const resultDiv = document.getElementById('wikiResult');
        resultDiv.innerHTML = '<div style="text-align:center;margin-top:20px">ğŸ¤– AI è¯å‰‚å¸ˆæ­£åœ¨æŸ¥é˜…èµ„æ–™...</div>';
        
        try {
            const prompt = `è¯·æ‰®æ¼”ä¸“ä¸šè¯å‰‚å¸ˆï¼Œä¸ºç”¨æˆ·è¯¦ç»†ä»‹ç»è¯å“ã€${name}ã€‘ã€‚è¯·æŒ‰ä»¥ä¸‹æ ¼å¼è¾“å‡ºï¼š
            ã€è¯å“åç§°ã€‘${name}
            ã€åŠŸèƒ½ä¸»æ²»ã€‘(é€šä¿—æ˜“æ‡‚çš„è§£é‡Š)
            ã€ç”¨æ³•ç”¨é‡ã€‘(å¸¸è§„å»ºè®®)
            ã€å‰¯ä½œç”¨/ä¸è‰¯ååº”ã€‘
            ã€ç¦å¿Œäººç¾¤ã€‘(è°ç»å¯¹ä¸èƒ½åƒ)
            ã€æ³¨æ„äº‹é¡¹ã€‘
            
            ä¸è¦ä½¿ç”¨Markdownæ ¼å¼ï¼Œç›´æ¥ç”¨çº¯æ–‡æœ¬åˆ†æ®µæ˜¾ç¤ºã€‚`;

            const res = await fetch("https://api.deepseek.com/chat/completions", {
                method: "POST",
                headers: { "Content-Type": "application/json", "Authorization": `Bearer ${AI_API_KEY}` },
                body: JSON.stringify({
                    model: "deepseek-chat",
                    messages: [{role: "user", content: prompt}],
                    temperature: 0.3
                })
            });
            const data = await res.json();
            const text = data.choices[0].message.content;
            
            // ç®€å•çš„æ ¼å¼åŒ–ï¼ŒæŠŠæ¢è¡Œå˜æˆHTMLæ¢è¡Œ
            resultDiv.innerHTML = text.replace(/\n/g, '<br>');
            
        } catch(e) {
            resultDiv.innerHTML = `<div style="color:red">æŸ¥è¯¢å¤±è´¥ï¼š${e.message}</div>`;
        }
    }

    // --- åº“å­˜ç®¡ç† ---
    async function fetchDrugs() {
        showLoading(true, "åŒæ­¥æ•°æ®...");
        const query = new AV.Query('Medicine');
        query.descending('createdAt');
        query.limit(1000);
        try {
            allDrugsCache = await query.find();
            renderList(allDrugsCache);
        } catch(e) { console.error(e); }
        showLoading(false);
    }

    async function saveDrug() {
        const name = document.getElementById('name').value;
        const expiry = document.getElementById('expiry').value;
        if(!name || !expiry) return alert("å†™åç§°å’Œæœ‰æ•ˆæœŸ");
        showLoading(true);

        const selectedTags = [];
        document.querySelectorAll('.check-tag.checked').forEach(el => selectedTags.push(el.innerText));

        try {
            let drug = currentEditingId ? AV.Object.createWithoutData('Medicine', currentEditingId) : new (AV.Object.extend('Medicine'))();
            drug.set('name', name);
            drug.set('expiry', expiry);
            drug.set('quantity', document.getElementById('quantity').value);
            drug.set('target', document.getElementById('target').value);
            drug.set('gender', document.getElementById('gender').value);
            drug.set('usage', document.getElementById('usage').value);
            drug.set('dosage', document.getElementById('dosage').value);
            drug.set('notes', document.getElementById('notes').value);
            drug.set('tags', selectedTags);
            await drug.save();
            closeForm();
            fetchDrugs();
        } catch(e) { alert("ä¿å­˜å¤±è´¥"); }
        showLoading(false);
    }

    function editDrug(id) {
        const drug = allDrugsCache.find(d => d.id === id);
        if(!drug) return;
        currentEditingId = id;
        openForm(true);
        document.getElementById('name').value = drug.get('name');
        document.getElementById('expiry').value = drug.get('expiry');
        document.getElementById('quantity').value = drug.get('quantity')||'';
        document.getElementById('target').value = drug.get('target');
        document.getElementById('gender').value = drug.get('gender');
        document.getElementById('usage').value = drug.get('usage')||'';
        document.getElementById('dosage').value = drug.get('dosage')||'';
        document.getElementById('notes').value = drug.get('notes')||'';
        
        const tags = drug.get('tags')||[];
        document.querySelectorAll('.check-tag').forEach(el => {
            el.classList.toggle('checked', tags.includes(el.innerText));
        });
    }

    async function deleteDrug(id) {
        if(!confirm("ç¡®å®šåˆ é™¤ï¼Ÿ")) return;
        const drug = AV.Object.createWithoutData('Medicine', id);
        await drug.destroy();
        fetchDrugs();
    }

    // --- ç•Œé¢æ§åˆ¶ ---
    function openForm(isEdit=false) {
        document.getElementById('inputCard').classList.add('show');
        document.getElementById('formTitle').innerText = isEdit ? "âœï¸ ç¼–è¾‘è¯å“" : "ğŸ’Š æ·»åŠ æ–°è¯";
        document.getElementById('saveBtn').innerText = isEdit ? "ä¿å­˜ä¿®æ”¹" : "æ”¾å…¥è¯ç®±";
        if(!isEdit) {
            document.querySelectorAll('#inputCard input').forEach(i=>i.value='');
            document.querySelectorAll('.check-tag').forEach(t=>t.classList.remove('checked'));
            currentEditingId = null;
        }
        document.getElementById('inputCard').scrollIntoView({behavior:"smooth"});
    }
    function closeForm() {
        document.getElementById('inputCard').classList.remove('show');
        currentEditingId = null;
    }

    // --- AI è‡ªåŠ¨å¡«å• (å…¥åº“ç”¨) ---
    async function identifyDrug() {
        const val = document.getElementById('name').value.trim();
        if(!val) return alert("è¾“å…¥åç§°");
        showLoading(true, "AI åˆ†æä¸­...");
        try {
            const res = await fetch("https://api.deepseek.com/chat/completions", {
                method: "POST",
                headers: { "Content-Type": "application/json", "Authorization": `Bearer ${AI_API_KEY}` },
                body: JSON.stringify({
                    model: "deepseek-chat",
                    messages: [{role: "system", content: "è¿”å›JSON: name,target,gender,usage,dosage,notes,tags(ä»ç»™å®šåˆ—è¡¨é€‰)"}, 
                              {role: "user", content: `è¯å“:${val}ã€‚æ ‡ç­¾åˆ—è¡¨:${TAG_LIST.join(',')}`}
                    ],
                    temperature: 0.1
                })
            });
            const data = await res.json();
            const result = JSON.parse(data.choices[0].message.content.replace(/```json/g,'').replace(/```/g,''));
            
            if(result.name) document.getElementById('name').value = result.name;
            ['target','gender','usage','dosage','notes'].forEach(k => { if(result[k]) document.getElementById(k).value = result[k]; });
            if(result.tags) {
                document.querySelectorAll('.check-tag').forEach(el => {
                    el.classList.toggle('checked', result.tags.includes(el.innerText));
                });
            }
        } catch(e) { alert("è¯†åˆ«å¤±è´¥"); }
        showLoading(false);
    }

    // --- åˆ—è¡¨æ¸²æŸ“ ---
    function renderList(drugs) {
        const listDiv = document.getElementById('drugList');
        listDiv.innerHTML = '';
        if(drugs.length === 0) return listDiv.innerHTML = '<div style="text-align:center;color:#999;margin-top:20px">æš‚æ— è¯å“</div>';

        [...drugs].sort((a,b) => new Date(a.get('expiry')) - new Date(b.get('expiry'))).forEach(d => {
            const status = getStatus(d.get('expiry'));
            const tags = d.get('tags') || [];
            const div = document.createElement('div');
            div.className = `drug-card ${status.code}`;
            div.innerHTML = `
                <div class="card-actions">
                    <button class="icon-btn" onclick="editDrug('${d.id}')">âœ</button>
                    <button class="icon-btn" onclick="deleteDrug('${d.id}')">ğŸ—‘</button>
                </div>
                <h3 class="drug-name">${d.get('name')}</h3>
                <div class="info-row">
                    <span style="color:${status.color};font-weight:bold">${status.text}</span> | 
                    <span>åº“å­˜: ${d.get('quantity')||'-'}</span> | 
                    <span>${d.get('target')}</span>
                </div>
                <div style="margin-bottom:8px">${tags.map(t=>`<span class="mini-tag">${t}</span>`).join('')}</div>
                <div style="font-size:0.9em;color:#4b5563">
                    <div><strong>ä¸»æ²»:</strong> ${d.get('usage')||'-'}</div>
                    <div><strong>ç”¨æ³•:</strong> ${d.get('dosage')||'-'}</div>
                    ${d.get('notes') ? `<div style="color:#e11d48;margin-top:4px">âš ï¸ ${d.get('notes')}</div>` : ''}
                </div>
            `;
            listDiv.appendChild(div);
        });
    }

    function filterBy(type, btn) {
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('searchInput').value = '';
        
        let filtered = [];
        const today = new Date(); today.setHours(0,0,0,0);

        if(type==='all') filtered = allDrugsCache;
        else if(type==='expired') filtered = allDrugsCache.filter(d => (new Date(d.get('expiry'))-today) < 0);
        else if(type==='expiring') filtered = allDrugsCache.filter(d => {
            const diff = (new Date(d.get('expiry'))-today)/86400000;
            return diff >= 0 && diff <= 90;
        });
        else filtered = allDrugsCache.filter(d => (d.get('tags')||[]).includes(type));
        renderList(filtered);
    }

    function handleSearch() {
        const val = document.getElementById('searchInput').value.toLowerCase();
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
        renderList(allDrugsCache.filter(d => (d.get('name')+d.get('usage')+(d.get('notes')||'')).toLowerCase().includes(val)));
    }

    function getStatus(d) {
        const diff = Math.ceil((new Date(d) - new Date())/86400000);
        if(diff < 0) return {code:'expired', text:`è¿‡æœŸ ${Math.abs(diff)}å¤©`, color:'#d73a49'};
        if(diff <= 90) return {code:'warning', text:`å‰© ${diff}å¤©`, color:'#d97706'};
        return {code:'normal', text:`æœ‰æ•ˆæœŸè‡³ ${d}`, color:'#059669'};
    }

    function startScanner() {
        document.getElementById('scanner-modal').style.display = 'flex';
        html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start({facingMode:"environment"}, {fps:10, qrbox:{width:250,height:250}}, 
        (t) => { stopScanner(); document.getElementById('name').value = t; identifyDrug(); })
        .catch(() => { alert("æ— æ³•å¯åŠ¨æ‘„åƒå¤´"); stopScanner(); });
    }
    function stopScanner() {
        document.getElementById('scanner-modal').style.display = 'none';
        if(html5QrCode) html5QrCode.stop().then(()=>html5QrCode.clear()).catch(()=>{});
    }
    function showLoading(show, txt) {
        document.getElementById('loading-overlay').style.display = show?'flex':'none';
        if(txt) document.getElementById('loading-text').innerText = txt;
    }
</script>
</body>
</html>
