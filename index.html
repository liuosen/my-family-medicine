<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ™ºèƒ½æ‰«ç è¯ç®±</title>
    <!-- å¼•å…¥ LeanCloud SDK -->
    <script src="//cdn.jsdelivr.net/npm/leancloud-storage@4.15.0/dist/av-min.js"></script>
    <!-- å¼•å…¥ æ‰«ç åº“ html5-qrcode -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        :root { --primary: #10a37f; --danger: #d73a49; --warning: #d4a72c; --bg: #f0f2f5; --card: #fff; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); padding: 15px; color: #333; margin: 0; padding-bottom: 50px; }
        .container { max-width: 800px; margin: 0 auto; }
        h2 { text-align: center; color: #2c3e50; margin-bottom: 15px; }
        
        /* æœç´¢åŒºåŸŸ */
        .filter-section { position: sticky; top: 0; background: var(--bg); z-index: 90; padding: 10px 0; }
        .search-box { position: relative; margin-bottom: 10px; }
        .search-box input { width: 100%; padding: 12px 15px 12px 40px; border: 1px solid #ddd; border-radius: 25px; font-size: 16px; box-sizing: border-box; }
        .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #999; }
        
        /* åˆ†ç±»æŒ‰é’® */
        .category-scroll { display: flex; overflow-x: auto; gap: 8px; padding-bottom: 5px; scrollbar-width: none; }
        .category-scroll::-webkit-scrollbar { display: none; }
        .cat-btn { white-space: nowrap; padding: 6px 14px; border-radius: 20px; border: 1px solid #ddd; background: white; color: #555; cursor: pointer; transition: 0.2s; }
        .cat-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* è¾“å…¥å¡ç‰‡ */
        .toggle-input-btn { width: 100%; padding: 12px; background: white; border: 1px dashed #999; color: #555; border-radius: 8px; cursor: pointer; margin-bottom: 15px; font-weight: bold; }
        .input-card { background: var(--card); padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; display: none; }
        .input-card.show { display: block; animation: slideDown 0.3s; }

        .input-group { display: flex; gap: 8px; margin-bottom: 15px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 0.9em; color: #555; }
        
        /* æŒ‰é’®ç»„ */
        .btn { border: none; padding: 10px; border-radius: 6px; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-scan { background: #333; color: white; flex-shrink: 0; width: 50px; }
        .btn-ai { background: var(--primary); color: white; flex-shrink: 0; }
        .btn-save { background: #2c3e50; color: white; width: 100%; margin-top: 15px; padding: 12px; font-size: 16px; }

        /* åˆ—è¡¨å¡ç‰‡ */
        .drug-card { background: var(--card); padding: 15px; margin-bottom: 12px; border-radius: 8px; border-left: 5px solid var(--primary); position: relative; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .drug-card.expired { border-left-color: var(--danger); background: #fff5f5; }
        .drug-card.warning { border-left-color: var(--warning); background: #fffcf0; }
        .delete-btn { position: absolute; top: 10px; right: 10px; background: none; border: none; color: #ccc; font-size: 20px; cursor: pointer; }
        .card-header { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 8px; padding-right: 30px; align-items: center; }
        .badge { padding: 2px 8px; border-radius: 10px; font-size: 0.75em; background: #eee; color: #555; }
        .badge.status { color: #fff; }
        
        /* æ‰«ç å¼¹çª— */
        #scanner-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; display: none; flex-direction: column; justify-content: center; align-items: center; }
        #reader { width: 100%; max-width: 500px; background: #000; }
        .close-scanner { position: absolute; top: 20px; right: 20px; color: white; font-size: 30px; cursor: pointer; z-index: 1001; }
        .scanner-tip { color: white; margin-top: 10px; text-align: center; }

        /* Loading */
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.85); display: none; justify-content: center; align-items: center; z-index: 999; flex-direction: column; backdrop-filter: blur(2px); }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<!-- æ‰«ç å¼¹çª—ç•Œé¢ -->
<div id="scanner-modal">
    <div class="close-scanner" onclick="stopScanner()">Ã—</div>
    <div id="reader"></div>
    <div class="scanner-tip">è¯·å°†æ¡å½¢ç å¯¹å‡†æ–¹æ¡†</div>
</div>

<!-- Loading ç•Œé¢ -->
<div id="loading-overlay">
    <div class="spinner"></div>
    <div id="loading-text">å¤„ç†ä¸­...</div>
</div>

<div class="container">
    <h2>ğŸ¥ AI æ™ºèƒ½æ‰«ç è¯ç®±</h2>

    <!-- 1. æœç´¢åŒº -->
    <div class="filter-section">
        <div class="search-box">
            <span class="search-icon">ğŸ”</span>
            <input type="text" id="searchInput" placeholder="æœç´¢è¯åã€åŠŸèƒ½..." oninput="handleSearch()">
        </div>
        <div class="category-scroll">
            <button class="cat-btn active" onclick="filterByCategory('å…¨éƒ¨', this)">å…¨éƒ¨</button>
            <button class="cat-btn" onclick="filterByCategory('æ„Ÿå†’å‘çƒ§', this)">ğŸŒ¡ï¸ æ„Ÿå†’å‘çƒ§</button>
            <button class="cat-btn" onclick="filterByCategory('å’³å—½å’½ç—›', this)">ğŸ˜®â€ğŸ’¨ å’³å—½å’½ç—›</button>
            <button class="cat-btn" onclick="filterByCategory('è‚ èƒƒ', this)">ğŸ¥£ è‚ èƒƒæ¶ˆåŒ–</button>
            <button class="cat-btn" onclick="filterByCategory('å¤–ç”¨', this)">ğŸ©¹ å¤–ç”¨/çš®è‚¤</button>
            <button class="cat-btn" onclick="filterByCategory('å„¿ç«¥', this)">ğŸ‘¶ å„¿ç«¥ä¸“ç”¨</button>
            <button class="cat-btn" onclick="filterByCategory('è€äºº', this)">ğŸ§“ è€äºº/æ…¢ç—…</button>
        </div>
    </div>

    <!-- 2. å½•å…¥åŒº -->
    <button class="toggle-input-btn" onclick="toggleInputCard()">â• æ‰«ç  / æ·»åŠ è¯å“</button>
    
    <div class="input-card" id="inputCard">
        <div class="input-group">
            <div style="flex-grow:1">
                <label>è¯å“åç§° / æ¡å½¢ç </label>
                <input type="text" id="name" placeholder="è¾“å…¥åç§° æˆ– ç‚¹å‡»æ‰«ç ">
            </div>
            <div style="display:flex; align-items:flex-end; gap:5px;">
                <button class="btn btn-scan" onclick="startScanner()">ğŸ“·</button>
                <button class="btn btn-ai" onclick="identifyDrug()">âœ¨ è¯†åˆ«</button>
            </div>
        </div>
        
        <div class="form-grid">
            <div><label>é€‚ç”¨äººç¾¤</label><select id="target"><option value="é€šç”¨">é€šç”¨</option><option value="æˆäºº">æˆäºº</option><option value="å„¿ç«¥">å„¿ç«¥</option><option value="è€äºº">è€äºº</option></select></div>
            <div><label>é€‚ç”¨æ€§åˆ«</label><select id="gender"><option value="é€šç”¨">é€šç”¨</option><option value="ç”·æ€§">ç”·æ€§</option><option value="å¥³æ€§">å¥³æ€§</option></select></div>
            <div><label>æœ‰æ•ˆæœŸè‡³</label><input type="date" id="expiry"></div>
            <div><label>åº“å­˜</label><input type="text" id="quantity" placeholder="1ç›’"></div>
            <div style="grid-column: 1/-1"><label>ä¸»æ²»åŠŸèƒ½</label><input type="text" id="usage" placeholder="è‡ªåŠ¨å¡«å……..."></div>
            <div style="grid-column: 1/-1"><label>ç”¨æ³•ç”¨é‡</label><input type="text" id="dosage" placeholder="è‡ªåŠ¨å¡«å……..."></div>
            <div style="grid-column: 1/-1"><label>æ³¨æ„äº‹é¡¹</label><input type="text" id="notes" placeholder="è‡ªåŠ¨å¡«å……..." style="border-color: #ffd7d7;"></div>
        </div>
        <button class="btn btn-save" onclick="addDrug()">ğŸ“¥ æ”¾å…¥è¯ç®±</button>
    </div>

    <!-- 3. åˆ—è¡¨åŒº -->
    <div id="drugList"></div>
</div>

<script>
    // ================= é…ç½®åŒºåŸŸ =================
    const LC_APP_ID = 'ä½ çš„LeanCloud AppID';
    const LC_APP_KEY = 'ä½ çš„LeanCloud AppKey';
    const AI_API_KEY = 'ä½ çš„DeepSeek Key (sk-å¼€å¤´)';
    // ===========================================

    let allDrugsCache = [];
    let html5QrCode; // æ‰«ç å™¨å®ä¾‹

    // åˆå§‹åŒ–
    if (!LC_APP_ID.includes('AppID')) {
        AV.init({ appId: LC_APP_ID, appKey: LC_APP_KEY, serverURL: "https://ulnxpw1a.lc-cn-n1-shared.com" });
    }

    document.addEventListener('DOMContentLoaded', () => {
        if (LC_APP_ID.includes('AppID')) return alert("è¯·é…ç½®ä»£ç é¡¶éƒ¨çš„ ID å’Œ Keyï¼");
        fetchDrugs();
    });

    // --- ğŸ“· æ‰«ç åŠŸèƒ½é€»è¾‘ ---
    function startScanner() {
        // æ‰“å¼€è¾“å…¥é¢æ¿
        document.getElementById('inputCard').classList.add('show');
        document.getElementById('scanner-modal').style.display = 'flex';

        html5QrCode = new Html5Qrcode("reader");
        const config = { fps: 10, qrbox: { width: 250, height: 250 }, aspectRatio: 1.0 };
        
        // å¯åŠ¨åç½®æ‘„åƒå¤´
        html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess)
        .catch(err => {
            alert("æ— æ³•å¯åŠ¨æ‘„åƒå¤´ï¼Œè¯·æ£€æŸ¥æƒé™æˆ–ä½¿ç”¨ HTTPS åè®®ã€‚\né”™è¯¯: " + err);
            stopScanner();
        });
    }

    function onScanSuccess(decodedText, decodedResult) {
        // æ‰«ç æˆåŠŸ
        stopScanner();
        document.getElementById('name').value = decodedText;
        // éœ‡åŠ¨åé¦ˆ (å¦‚æœè®¾å¤‡æ”¯æŒ)
        if(navigator.vibrate) navigator.vibrate(200);
        
        // è‡ªåŠ¨è§¦å‘ AI è¯†åˆ«
        showLoading(true, `å·²æ‰«æ: ${decodedText}\næ­£åœ¨å°è¯•è¯†åˆ«...`);
        identifyDrug(); // è¿™é‡Œçš„ identifyDrug å·²ç»æ”¹é€ è¿‡ï¼Œä¼šå¤„ç†æ•°å­—
    }

    function stopScanner() {
        document.getElementById('scanner-modal').style.display = 'none';
        if (html5QrCode) {
            html5QrCode.stop().then(() => { html5QrCode.clear(); }).catch(err => console.log(err));
        }
    }

    // --- ğŸ¤– AI è¯†åˆ«é€»è¾‘ (å‡çº§ç‰ˆ) ---
    async function identifyDrug() {
        const inputVal = document.getElementById('name').value.trim();
        if (!inputVal) return alert("è¯·å…ˆè¾“å…¥åç§°æˆ–æ‰«ç ");

        showLoading(true, "AI æ­£åœ¨æŸ¥è¯¢...");

        // å¦‚æœæ˜¯çº¯æ•°å­—ï¼ˆæ¡å½¢ç ï¼‰ï¼Œæç¤ºè¯­ç¨å¾®å˜ä¸€ä¸‹
        const isBarcode = /^\d+$/.test(inputVal);
        const userPrompt = isBarcode 
            ? `ç”¨æˆ·è¾“å…¥äº†æ¡å½¢ç ï¼š${inputVal}ã€‚è¯·å°è¯•æ¨æµ‹è¿™æ˜¯ä»€ä¹ˆè¯å“ã€‚å¦‚æœèƒ½ç¡®å®šï¼Œè¿”å›è¯å“åç§°å’Œå…¶ä»–ä¿¡æ¯ã€‚å¦‚æœå®Œå…¨æ— æ³•è¯†åˆ«è¯¥æ¡å½¢ç ï¼Œè¯·è¿”å› name ä¸ºç©ºå­—ç¬¦ä¸²ã€‚` 
            : `è¯å“åç§°ï¼š${inputVal}`;

        try {
            const response = await fetch("https://api.deepseek.com/v1/chat/completions", {
                method: "POST",
                headers: { "Content-Type": "application/json", "Authorization": `Bearer ${AI_API_KEY}` },
                body: JSON.stringify({
                    model: "deepseek-chat",
                    messages: [
                        { role: "system", content: `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è¯å‰‚å¸ˆã€‚è¯·ä»¥çº¯JSONæ ¼å¼è¿”å›è¯å“ä¿¡æ¯ï¼š
                        name (å¦‚æœæ˜¯æ¡å½¢ç ï¼Œè¯·æ¨æ–­è¯åï¼Œå¦‚æœæ— æ³•æ¨æ–­ï¼Œç•™ç©º),
                        target (æˆäºº/å„¿ç«¥/é€šç”¨/è€äºº), 
                        gender (ç”·æ€§/å¥³æ€§/é€šç”¨), 
                        usage (ç®€çŸ­ä¸»æ²»åŠŸèƒ½), 
                        dosage (å¸¸è§„ç”¨æ³•), 
                        notes (æ³¨æ„äº‹é¡¹)ã€‚
                        ä¸è¦Markdownã€‚` },
                        { role: "user", content: userPrompt }
                    ],
                    temperature: 0.1
                })
            });

            const data = await response.json();
            let rawJson = data.choices[0].message.content.replace(/```json/g, '').replace(/```/g, '').trim();
            const result = JSON.parse(rawJson);

            if (result.name) {
                document.getElementById('name').value = result.name; // æ›´æ–°ä¸ºçœŸæ­£çš„è¯å
                document.getElementById('target').value = result.target || 'é€šç”¨';
                document.getElementById('gender').value = result.gender || 'é€šç”¨';
                document.getElementById('usage').value = result.usage || '';
                document.getElementById('dosage').value = result.dosage || '';
                document.getElementById('notes').value = result.notes || '';
            } else {
                alert("AI æš‚æ—¶æ— æ³•è¯†åˆ«è¿™ä¸ªæ¡å½¢ç å¯¹åº”çš„è¯å“ã€‚\nè¯·æ‰‹åŠ¨è¾“å…¥è¯å“åç§°åå†ç‚¹å‡»è¯†åˆ«ã€‚");
            }

        } catch (error) {
            console.error(error);
            alert("è¯†åˆ«è¯·æ±‚å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¡«å†™ã€‚");
        } finally {
            showLoading(false);
        }
    }

    // --- â˜ï¸ æ•°æ®åº“ä¸åˆ—è¡¨é€»è¾‘ (ä¿æŒä¸€è‡´) ---
    function toggleInputCard() {
        document.getElementById('inputCard').classList.toggle('show');
    }

    async function fetchDrugs() {
        const query = new AV.Query('Medicine');
        query.descending('createdAt');
        query.limit(100);
        try {
            allDrugsCache = await query.find();
            renderList(allDrugsCache);
        } catch (error) { console.error(error); }
    }

    function handleSearch() {
        const keyword = document.getElementById('searchInput').value.toLowerCase().trim();
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
        
        const filtered = allDrugsCache.filter(drug => {
            const n = (drug.get('name') || '').toLowerCase();
            const u = (drug.get('usage') || '').toLowerCase();
            return n.includes(keyword) || u.includes(keyword);
        });
        renderList(filtered);
    }

    function filterByCategory(category, btn) {
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
        if(btn) btn.classList.add('active');
        document.getElementById('searchInput').value = '';

        if (category === 'å…¨éƒ¨') return renderList(allDrugsCache);

        const map = {
            'æ„Ÿå†’å‘çƒ§': ['æ„Ÿå†’', 'çƒ§', 'çƒ­', 'æµæ„Ÿ', 'é¼»å¡', 'é€€çƒ­'],
            'å’³å—½å’½ç—›': ['å’³', 'ç—°', 'å’½', 'å–‰'],
            'è‚ èƒƒ': ['èƒƒ', 'è‚ ', 'æ³»', 'æ¶ˆåŒ–'],
            'å¤–ç”¨': ['è†', 'è´´', 'çš®', 'ç—’', 'å–·'],
            'å„¿ç«¥': ['å„¿', 'å®', 'ç¨š'],
            'è€äºº': ['å‹', 'ç³–', 'å¿ƒ', 'è„‘']
        };
        const keywords = map[category] || [];

        const filtered = allDrugsCache.filter(d => {
            if (category === 'å„¿ç«¥' && d.get('target') === 'å„¿ç«¥') return true;
            if (category === 'è€äºº' && d.get('target') === 'è€äºº') return true;
            const text = (d.get('name') + d.get('usage')).toLowerCase();
            return keywords.some(k => text.includes(k));
        });
        renderList(filtered);
    }

    function renderList(drugs) {
        const listDiv = document.getElementById('drugList');
        listDiv.innerHTML = '';
        const sorted = [...drugs].sort((a, b) => new Date(a.get('expiry')) - new Date(b.get('expiry')));
        
        sorted.forEach(d => {
            const status = getStatus(d.get('expiry'));
            const div = document.createElement('div');
            div.className = `drug-card ${status.code}`;
            div.innerHTML = `
                <button class="delete-btn" onclick="deleteDrug('${d.id}')">Ã—</button>
                <div class="card-header">
                    <h3 style="margin:0">${d.get('name')}</h3>
                    <span class="badge status" style="background:${status.color}">${status.text}</span>
                    <span class="badge">${d.get('target')}</span>
                </div>
                <div style="font-size:0.9em;color:#666;line-height:1.6">
                    <div>ğŸ’Š <strong>åŠŸèƒ½:</strong> ${d.get('usage')}</div>
                    <div>ğŸ¥„ <strong>ç”¨æ³•:</strong> ${d.get('dosage')}</div>
                    <div>ğŸ“¦ <strong>åº“å­˜:</strong> ${d.get('quantity')}</div>
                    ${d.get('notes') ? `<div style="color:#d73a49;background:rgba(215,58,73,0.05);padding:4px;margin-top:4px;border-radius:4px">âš ï¸ ${d.get('notes')}</div>` : ''}
                </div>
            `;
            listDiv.appendChild(div);
        });
    }

    async function addDrug() {
        const name = document.getElementById('name').value;
        const expiry = document.getElementById('expiry').value;
        if (!name || !expiry) return alert("è¯·å¡«å†™å®Œæ•´ï¼");
        showLoading(true, "ä¿å­˜ä¸­...");
        
        const Medicine = AV.Object.extend('Medicine');
        const drug = new Medicine();
        ['name','target','gender','expiry','usage','dosage','quantity','notes'].forEach(f => drug.set(f, document.getElementById(f).value));
        
        await drug.save();
        document.querySelectorAll('input').forEach(i => i.value='');
        toggleInputCard();
        fetchDrugs();
        showLoading(false);
    }

    async function deleteDrug(id) {
        if(!confirm("ç¡®å®šåˆ é™¤?")) return;
        const drug = AV.Object.createWithoutData('Medicine', id);
        await drug.destroy();
        fetchDrugs();
    }

    function getStatus(d) {
        const diff = Math.ceil((new Date(d) - new Date()) / 86400000);
        if (diff < 0) return {code:'expired', text:`è¿‡æœŸ ${Math.abs(diff)} å¤©`, color:'#d73a49'};
        if (diff < 30) return {code:'warning', text:`å‰© ${diff} å¤©`, color:'#d4a72c'};
        return {code:'normal', text:`æœ‰æ•ˆæœŸ ${d}`, color:'#10a37f'};
    }

    function showLoading(show, text) {
        document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none';
        if(text) document.getElementById('loading-text').innerText = text;
    }
</script>
</body>
</html>