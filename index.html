<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ™ºèƒ½è¯ç®± (æ——èˆ°ç‰ˆ)</title>
    <script src="//cdn.jsdelivr.net/npm/leancloud-storage@4.15.0/dist/av-min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        :root { --primary: #10a37f; --primary-dark: #0d8a6c; --danger: #d73a49; --warning: #f59e0b; --blue: #3b82f6; --bg: #f3f4f6; --card: #fff; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); padding: 15px; color: #1f2937; margin: 0; padding-bottom: 80px; }
        .container { max-width: 800px; margin: 0 auto; display: none; }
        h2 { text-align: center; color: #374151; margin-bottom: 15px; font-weight: 700; }
        
        /* ç™»å½•æ¡† */
        #login-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 10000; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; }
        .pass-input { padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 18px; text-align: center; margin-bottom: 15px; outline: none; }
        .pass-input:focus { border-color: var(--primary); }
        .login-btn { padding: 12px 30px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 16px; }

        /* é¡¶éƒ¨ç­›é€‰æ  */
        .filter-section { position: sticky; top: 0; background: var(--bg); z-index: 90; padding: 10px 0; border-bottom: 1px solid #e5e7eb; }
        .search-box { position: relative; margin-bottom: 10px; }
        .search-box input { width: 100%; padding: 12px 15px 12px 40px; border: 1px solid #e5e7eb; border-radius: 25px; font-size: 16px; box-sizing: border-box; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #9ca3af; }
        
        .category-scroll { display: flex; overflow-x: auto; gap: 8px; padding-bottom: 8px; scrollbar-width: none; -webkit-overflow-scrolling: touch; }
        .category-scroll::-webkit-scrollbar { display: none; }
        .cat-btn { white-space: nowrap; padding: 6px 16px; border-radius: 20px; border: 1px solid #e5e7eb; background: white; color: #4b5563; font-size: 14px; transition: all 0.2s; }
        .cat-btn.active { background: var(--primary); color: white; border-color: var(--primary); font-weight: 600; box-shadow: 0 2px 5px rgba(16, 163, 127, 0.3); }
        .cat-btn.special { border-color: #fcd34d; color: #b45309; }
        .cat-btn.special.active { background: var(--warning); color: white; border-color: var(--warning); }

        /* è¾“å…¥/ç¼–è¾‘å¡ç‰‡ */
        .toggle-btn { width: 100%; padding: 12px; background: white; border: 1px dashed #9ca3af; color: #6b7280; border-radius: 12px; margin-bottom: 15px; font-weight: 600; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 5px; }
        .input-card { background: var(--card); padding: 20px; border-radius: 16px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05); margin-bottom: 20px; display: none; border: 1px solid #e5e7eb; }
        .input-card.show { display: block; animation: slideDown 0.3s; }
        
        .form-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .full-width { grid-column: 1 / -1; }
        label { display: block; margin-bottom: 5px; font-size: 0.85em; font-weight: 600; color: #4b5563; }
        input, select { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; box-sizing: border-box; font-size: 15px; transition: border 0.2s; }
        input:focus { border-color: var(--primary); outline: none; ring: 2px var(--primary); }

        /* æ ‡ç­¾é€‰æ‹©åŒº (æ–°åŠŸèƒ½) */
        .tags-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 5px; }
        .check-tag { padding: 6px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; cursor: pointer; background: #f9fafb; user-select: none; transition: 0.2s; }
        .check-tag.checked { background: #ecfdf5; border-color: var(--primary); color: var(--primary-dark); font-weight: bold; }

        /* æŒ‰é’®ç»„ */
        .action-bar { display: flex; gap: 10px; margin-top: 20px; }
        .btn { flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; color: white; display: flex; justify-content: center; align-items: center; gap: 5px; }
        .btn-primary { background: var(--primary); }
        .btn-cancel { background: #9ca3af; }
        .btn-scan { background: #1f2937; width: auto; flex: 0 0 50px; }
        .btn-ai { background: linear-gradient(135deg, #3b82f6, #2563eb); width: auto; flex: 0 0 80px; font-size: 13px; }

        /* è¯å“å¡ç‰‡ */
        .drug-card { background: var(--card); padding: 16px; margin-bottom: 12px; border-radius: 12px; border-left: 6px solid var(--primary); position: relative; box-shadow: 0 1px 3px rgba(0,0,0,0.05); transition: transform 0.2s; }
        .drug-card:active { transform: scale(0.98); }
        .drug-card.expired { border-left-color: var(--danger); background: #fef2f2; }
        .drug-card.warning { border-left-color: var(--warning); background: #fffbeb; }

        .card-header { padding-right: 60px; } /* ç•™å‡ºæŒ‰é’®ç©ºé—´ */
        .drug-name { font-size: 1.15em; font-weight: 700; margin: 0 0 5px 0; color: #111827; }
        .info-row { display: flex; gap: 10px; font-size: 0.85em; color: #6b7280; margin-bottom: 8px; align-items: center; }
        .tag-row { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 8px; }
        .mini-tag { font-size: 11px; padding: 2px 6px; border-radius: 4px; background: #e5e7eb; color: #374151; }
        
        /* å¡ç‰‡æ“ä½œæŒ‰é’® */
        .card-actions { position: absolute; top: 12px; right: 12px; display: flex; gap: 8px; }
        .icon-btn { background: none; border: none; font-size: 18px; cursor: pointer; padding: 5px; color: #9ca3af; }
        .icon-btn.edit:hover { color: var(--blue); }
        .icon-btn.del:hover { color: var(--danger); }

        /* æ‚é¡¹ */
        #scanner-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:2000; flex-direction:column; justify-content:center; }
        #loading-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:1999; justify-content:center; align-items:center; flex-direction:column; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s infinite linear; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<!-- ç™»å½• -->
<div id="login-modal">
    <div style="font-size:40px;margin-bottom:10px">ğŸ’Š</div>
    <h3 style="margin-top:0">å®¶åº­è¯ç®±</h3>
    <input type="password" id="passwordInput" class="pass-input" placeholder="è¯·è¾“å…¥å¯†ç " onkeyup="if(event.key==='Enter') checkLogin()">
    <button class="login-btn" onclick="checkLogin()">è¿›å…¥</button>
</div>

<!-- æ‰«ç  -->
<div id="scanner-modal">
    <div style="position:absolute;top:20px;right:20px;color:white;font-size:30px;cursor:pointer" onclick="stopScanner()">Ã—</div>
    <div id="reader" style="width:100%;max-width:500px"></div>
</div>

<!-- Loading -->
<div id="loading-overlay">
    <div class="spinner"></div>
    <div id="loading-text" style="margin-top:15px;color:#666">åŠ è½½ä¸­...</div>
</div>

<div class="container" id="mainApp">
    <h2>ğŸ¥ æ™ºèƒ½å®¶åº­è¯ç®±</h2>

    <!-- 1. ç­›é€‰åŒº -->
    <div class="filter-section">
        <div class="search-box">
            <span class="search-icon">ğŸ”</span>
            <input type="text" id="searchInput" placeholder="æœç´¢è¯åã€åŠŸèƒ½..." oninput="handleSearch()">
        </div>
        <div class="category-scroll" id="filterBar">
            <!-- åŠ¨æ€ç”Ÿæˆçš„ç­›é€‰æŒ‰é’®ä¼šæ”¾åœ¨è¿™é‡Œ -->
            <button class="cat-btn active" onclick="filterBy('all', this)">å…¨éƒ¨</button>
            <button class="cat-btn special" onclick="filterBy('expired', this)">âš ï¸ å·²è¿‡æœŸ</button>
            <button class="cat-btn special" onclick="filterBy('expiring', this)">â³ å¿«è¿‡æœŸ</button>
        </div>
    </div>

    <!-- 2. æ“ä½œ/è¾“å…¥åŒº -->
    <div class="toggle-btn" onclick="openForm()">â• æ·»åŠ è¯å“</div>
    
    <div class="input-card" id="inputCard">
        <h3 style="margin-top:0;margin-bottom:15px;color:#374151" id="formTitle">æ·»åŠ æ–°è¯å“</h3>
        
        <div class="form-grid">
            <div class="full-width" style="display:flex;gap:8px">
                <div style="flex:1">
                    <label>è¯å“åç§° / æ¡å½¢ç </label>
                    <input type="text" id="name" placeholder="è¾“å…¥åç§° æˆ– æ‰«ç ">
                </div>
                <div style="display:flex;align-items:flex-end;gap:5px">
                    <button class="btn btn-scan" onclick="startScanner()">ğŸ“·</button>
                    <button class="btn btn-ai" onclick="identifyDrug()">âœ¨ è¯†åˆ«</button>
                </div>
            </div>

            <div class="full-width">
                <label>åŠŸèƒ½æ ‡ç­¾ (AI è‡ªåŠ¨å‹¾é€‰ï¼Œä¹Ÿå¯æ‰‹åŠ¨ç‚¹é€‰)</label>
                <div class="tags-container" id="tagSelectionArea">
                    <!-- JS ç”Ÿæˆæ ‡ç­¾ -->
                </div>
            </div>

            <div><label>æœ‰æ•ˆæœŸè‡³</label><input type="date" id="expiry"></div>
            <div><label>åº“å­˜æ•°é‡</label><input type="text" id="quantity" placeholder="å¦‚: 2ç›’"></div>
            
            <div><label>é€‚ç”¨äººç¾¤</label><select id="target"><option>é€šç”¨</option><option>æˆäºº</option><option>å„¿ç«¥</option><option>è€äºº</option></select></div>
            <div><label>é€‚ç”¨æ€§åˆ«</label><select id="gender"><option>é€šç”¨</option><option>ç”·æ€§</option><option>å¥³æ€§</option></select></div>
            
            <div class="full-width"><label>ä¸»æ²»åŠŸèƒ½ (è¯¦ç»†)</label><input type="text" id="usage"></div>
            <div class="full-width"><label>ç”¨æ³•ç”¨é‡</label><input type="text" id="dosage"></div>
            <div class="full-width"><label>æ³¨æ„äº‹é¡¹</label><input type="text" id="notes" style="border-color:#fecaca"></div>
        </div>

        <div class="action-bar">
            <button class="btn btn-cancel" onclick="closeForm()">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="saveDrug()" id="saveBtn">ğŸ“¥ ä¿å­˜</button>
        </div>
    </div>

    <!-- 3. åˆ—è¡¨åŒº -->
    <div id="drugList"></div>
</div>

<script>
    // ================== é…ç½®åŒº ==================
    const USER_PASSWORD = "285925";  // ä½ çš„å¯†ç 
    const LC_APP_ID = 'WebkPZV6qkXf2ILVmohQlIj7-gzGzoHsz';
    const LC_APP_KEY = 'pD4b4TdG7tEFioQBXOMbWWi6';
    const AI_API_KEY = 'sk-69074729a1fa403789c054d21d450d6f';

    // ğŸ·ï¸ å®šä¹‰ä½ æƒ³è¦çš„åˆ†ç±»æ ‡ç­¾
    const TAG_LIST = ["æ¶ˆç‚", "æ„Ÿå†’å‘çƒ§", "å’³å—½å’½ç—›", "æ­¢ç—›", "æ¶ˆåŒ–", "çš®è‚¤", "é«˜è¡€å‹", "å…³èŠ‚ç—›", "å¤–ç”¨", "æŠ—è¿‡æ•", "ç»´ç”Ÿç´ ", "å„¿ç«¥ä¸“ç”¨"];
    // ===========================================

    let allDrugsCache = [];
    let currentEditingId = null; // å½“å‰æ­£åœ¨ç¼–è¾‘çš„IDï¼Œç©ºåˆ™ä¸ºæ–°å¢
    let html5QrCode;

    // --- åˆå§‹åŒ– ---
    function init() {
        if(!LC_APP_ID.includes('AppID')) {
            AV.init({ appId: LC_APP_ID, appKey: LC_APP_KEY, serverURL: "https://ulnxpw1a.lc-cn-n1-shared.com" });
        }
        initTagsUI();
    }

    // ç”Ÿæˆæ ‡ç­¾UIï¼ˆè¾“å…¥æ¡†é‡Œçš„å’Œé¡¶éƒ¨çš„ï¼‰
    function initTagsUI() {
        // 1. ç”Ÿæˆé¡¶éƒ¨ç­›é€‰æ 
        const filterBar = document.getElementById('filterBar');
        TAG_LIST.forEach(tag => {
            const btn = document.createElement('button');
            btn.className = 'cat-btn';
            btn.innerText = tag;
            btn.onclick = function() { filterBy(tag, this) };
            filterBar.appendChild(btn);
        });

        // 2. ç”Ÿæˆè¡¨å•é‡Œçš„é€‰æ‹©æ¡†
        const tagArea = document.getElementById('tagSelectionArea');
        TAG_LIST.forEach(tag => {
            const span = document.createElement('span');
            span.className = 'check-tag';
            span.innerText = tag;
            span.onclick = function() { this.classList.toggle('checked'); };
            tagArea.appendChild(span);
        });
    }

    // --- ç™»å½•é€»è¾‘ ---
    function checkLogin() {
        if(document.getElementById('passwordInput').value === USER_PASSWORD) {
            document.getElementById('login-modal').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            init();
            fetchDrugs();
        } else {
            alert("å¯†ç é”™è¯¯");
        }
    }

    // --- æ•°æ®æ“ä½œ ---
    async function fetchDrugs() {
        showLoading(true, "åŒæ­¥æ•°æ®ä¸­...");
        const query = new AV.Query('Medicine');
        query.descending('createdAt');
        query.limit(1000);
        try {
            allDrugsCache = await query.find();
            renderList(allDrugsCache);
        } catch(e) { console.error(e); alert("è·å–å¤±è´¥"); }
        showLoading(false);
    }

    // ä¿å­˜ï¼ˆæ–°å¢ æˆ– ä¿®æ”¹ï¼‰
    async function saveDrug() {
        const name = document.getElementById('name').value;
        const expiry = document.getElementById('expiry').value;
        if(!name || !expiry) return alert("è¯·è‡³å°‘å¡«å†™åç§°å’Œæœ‰æ•ˆæœŸ");

        showLoading(true, "æ­£åœ¨ä¿å­˜...");
        
        // æ”¶é›†é€‰ä¸­çš„æ ‡ç­¾
        const selectedTags = [];
        document.querySelectorAll('.check-tag.checked').forEach(el => selectedTags.push(el.innerText));

        try {
            let drug;
            if (currentEditingId) {
                // ç¼–è¾‘æ¨¡å¼ï¼šè·å–å·²æœ‰å¯¹è±¡
                drug = AV.Object.createWithoutData('Medicine', currentEditingId);
            } else {
                // æ–°å¢æ¨¡å¼
                const Medicine = AV.Object.extend('Medicine');
                drug = new Medicine();
            }

            // å†™å…¥å­—æ®µ
            drug.set('name', name);
            drug.set('expiry', expiry);
            drug.set('quantity', document.getElementById('quantity').value);
            drug.set('target', document.getElementById('target').value);
            drug.set('gender', document.getElementById('gender').value);
            drug.set('usage', document.getElementById('usage').value);
            drug.set('dosage', document.getElementById('dosage').value);
            drug.set('notes', document.getElementById('notes').value);
            drug.set('tags', selectedTags); // ä¿å­˜æ ‡ç­¾æ•°ç»„

            await drug.save();
            closeForm();
            fetchDrugs(); // åˆ·æ–°åˆ—è¡¨
        } catch(e) {
            alert("ä¿å­˜å¤±è´¥: " + e.message);
        }
        showLoading(false);
    }

    // æ‰“å¼€ç¼–è¾‘
    function editDrug(id) {
        const drug = allDrugsCache.find(d => d.id === id);
        if(!drug) return;

        currentEditingId = id;
        openForm(true); // true è¡¨ç¤ºæ˜¯ç¼–è¾‘æ¨¡å¼

        // å¡«å…¥æ•°æ®
        document.getElementById('name').value = drug.get('name');
        document.getElementById('expiry').value = drug.get('expiry');
        document.getElementById('quantity').value = drug.get('quantity') || '';
        document.getElementById('target').value = drug.get('target');
        document.getElementById('gender').value = drug.get('gender');
        document.getElementById('usage').value = drug.get('usage') || '';
        document.getElementById('dosage').value = drug.get('dosage') || '';
        document.getElementById('notes').value = drug.get('notes') || '';

        // æ¢å¤æ ‡ç­¾çŠ¶æ€
        const savedTags = drug.get('tags') || [];
        document.querySelectorAll('.check-tag').forEach(el => {
            if (savedTags.includes(el.innerText)) {
                el.classList.add('checked');
            } else {
                el.classList.remove('checked');
            }
        });
    }

    async function deleteDrug(id) {
        if(!confirm("ç¡®å®šåˆ é™¤å—ï¼Ÿ")) return;
        const drug = AV.Object.createWithoutData('Medicine', id);
        await drug.destroy();
        fetchDrugs();
    }

    // --- è¡¨å•æ§åˆ¶ ---
    function openForm(isEdit = false) {
        document.getElementById('inputCard').classList.add('show');
        document.getElementById('formTitle').innerText = isEdit ? "âœï¸ ç¼–è¾‘è¯å“ä¿¡æ¯" : "ğŸ’Š æ·»åŠ æ–°è¯å“";
        document.getElementById('saveBtn').innerText = isEdit ? "ä¿å­˜ä¿®æ”¹" : "æ”¾å…¥è¯ç®±";
        if (!isEdit) {
            // å¦‚æœæ˜¯æ–°å¢ï¼Œæ¸…ç©ºè¡¨å•
            clearForm();
            currentEditingId = null;
        }
        // æ»šåŠ¨åˆ°è¡¨å•ä½ç½®
        document.getElementById('inputCard').scrollIntoView({behavior: "smooth"});
    }

    function closeForm() {
        document.getElementById('inputCard').classList.remove('show');
        clearForm();
        currentEditingId = null;
    }

    function clearForm() {
        document.querySelectorAll('input').forEach(i => i.value = '');
        document.querySelectorAll('.check-tag').forEach(t => t.classList.remove('checked'));
    }

    // --- AI è¯†åˆ« (å‡çº§ç‰ˆï¼šè‡ªåŠ¨é€‰æ ‡ç­¾) ---
    async function identifyDrug() {
        const val = document.getElementById('name').value.trim();
        if(!val) return alert("è¯·è¾“å…¥åç§°");
        showLoading(true, "AI æ­£åœ¨åˆ†æåˆ†ç±»...");

        try {
            const prompt = `è¯å“:${val}ã€‚è¯·è¿”å›JSONåŒ…å«: name, target(æˆäºº/å„¿ç«¥/é€šç”¨), gender, usage(ä¸»æ²»), dosage(ç”¨æ³•), notes(æ³¨æ„), tags(æ•°ç»„ï¼Œå¿…é¡»ä»ä»¥ä¸‹åˆ—è¡¨ä¸­é€‰æ‹©1-3ä¸ª: ${TAG_LIST.join(',')})ã€‚`;
            
            const res = await fetch("https://api.deepseek.com/chat/completions", {
                method: "POST",
                headers: { "Content-Type": "application/json", "Authorization": `Bearer ${AI_API_KEY}` },
                body: JSON.stringify({
                    model: "deepseek-chat",
                    messages: [{role: "system", content: "ä½ æ˜¯ä¸€ä¸ªè¯å‰‚å¸ˆã€‚åªè¿”å›çº¯JSONã€‚"}, {role: "user", content: prompt}],
                    temperature: 0.1
                })
            });
            
            const data = await res.json();
            const content = data.choices[0].message.content.replace(/```json/g,'').replace(/```/g,'').trim();
            const result = JSON.parse(content);

            if(result.name) document.getElementById('name').value = result.name;
            ['target','gender','usage','dosage','notes'].forEach(k => {
                if(result[k]) document.getElementById(k).value = result[k];
            });

            // è‡ªåŠ¨å‹¾é€‰æ ‡ç­¾
            if(result.tags && Array.isArray(result.tags)) {
                document.querySelectorAll('.check-tag').forEach(el => {
                    el.classList.remove('checked'); // å…ˆæ¸…ç©º
                    if(result.tags.includes(el.innerText)) el.classList.add('checked');
                });
            }

        } catch(e) { alert("è¯†åˆ«å¤±è´¥: " + e.message); }
        showLoading(false);
    }

    // --- åˆ—è¡¨æ¸²æŸ“ä¸ç­›é€‰ ---
    function renderList(drugs) {
        const listDiv = document.getElementById('drugList');
        listDiv.innerHTML = '';
        
        if(drugs.length === 0) {
            listDiv.innerHTML = '<div style="text-align:center;color:#9ca3af;margin-top:20px">æ²¡æœ‰è¯å“</div>';
            return;
        }

        const sorted = [...drugs].sort((a,b) => new Date(a.get('expiry')) - new Date(b.get('expiry')));

        sorted.forEach(d => {
            const status = getStatus(d.get('expiry'));
            const tags = d.get('tags') || [];
            
            const div = document.createElement('div');
            div.className = `drug-card ${status.code}`;
            div.innerHTML = `
                <div class="card-actions">
                    <button class="icon-btn edit" onclick="editDrug('${d.id}')">âœ</button>
                    <button class="icon-btn del" onclick="deleteDrug('${d.id}')">ğŸ—‘</button>
                </div>
                <h3 class="drug-name">${d.get('name')}</h3>
                <div class="info-row">
                    <span style="color:${status.color};font-weight:bold">${status.text}</span>
                    <span>|</span>
                    <span>åº“å­˜: ${d.get('quantity') || '-'}</span>
                    <span>|</span>
                    <span>${d.get('target')}</span>
                </div>
                <div class="tag-row">
                    ${tags.map(t => `<span class="mini-tag">${t}</span>`).join('')}
                </div>
                <div style="font-size:0.9em;color:#4b5563;margin-top:8px">
                    <div><strong>ä¸»æ²»:</strong> ${d.get('usage')||'-'}</div>
                    <div><strong>ç”¨æ³•:</strong> ${d.get('dosage')||'-'}</div>
                    ${d.get('notes') ? `<div style="color:#ef4444;margin-top:4px">âš ï¸ ${d.get('notes')}</div>` : ''}
                </div>
            `;
            listDiv.appendChild(div);
        });
    }

    function filterBy(type, btn) {
        // æ ·å¼åˆ‡æ¢
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('searchInput').value = '';

        let filtered = [];
        const today = new Date(); today.setHours(0,0,0,0);

        if (type === 'all') filtered = allDrugsCache;
        else if (type === 'expired') filtered = allDrugsCache.filter(d => (new Date(d.get('expiry')) - today) < 0);
        else if (type === 'expiring') {
            filtered = allDrugsCache.filter(d => {
                const diff = (new Date(d.get('expiry')) - today) / 86400000;
                return diff >= 0 && diff <= 90;
            });
        } 
        else {
            // æ ‡ç­¾åŒ¹é…é€»è¾‘ï¼šæ£€æŸ¥ drug.tags æ•°ç»„é‡Œæ˜¯å¦åŒ…å«å½“å‰ç‚¹å‡»çš„ tag
            filtered = allDrugsCache.filter(d => {
                const tags = d.get('tags') || [];
                return tags.includes(type);
            });
        }
        renderList(filtered);
    }

    function handleSearch() {
        const val = document.getElementById('searchInput').value.toLowerCase();
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
        
        const filtered = allDrugsCache.filter(d => {
            const txt = (d.get('name') + d.get('usage') + (d.get('notes')||'')).toLowerCase();
            return txt.includes(val);
        });
        renderList(filtered);
    }

    // å·¥å…·
    function getStatus(d) {
        const diff = Math.ceil((new Date(d) - new Date()) / 86400000);
        if (diff < 0) return {code:'expired', text:`å·²è¿‡æœŸ ${Math.abs(diff)} å¤©`, color:'#dc2626'};
        if (diff <= 90) return {code:'warning', text:`å‰© ${diff} å¤©`, color:'#d97706'};
        return {code:'normal', text:`æœ‰æ•ˆæœŸè‡³ ${d}`, color:'#059669'};
    }
    
    // æ‰«ç ç›¸å…³
    function startScanner() {
        document.getElementById('scanner-modal').style.display = 'flex';
        html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start({facingMode:"environment"}, {fps:10, qrbox:{width:250,height:250}}, 
        (txt) => { stopScanner(); document.getElementById('name').value = txt; identifyDrug(); })
        .catch(err => { alert("æ— æ³•å¯åŠ¨æ‘„åƒå¤´"); stopScanner(); });
    }
    function stopScanner() {
        document.getElementById('scanner-modal').style.display = 'none';
        if(html5QrCode) html5QrCode.stop().then(()=>html5QrCode.clear()).catch(()=>{});
    }
    function showLoading(show, txt) {
        document.getElementById('loading-overlay').style.display = show?'flex':'none';
        if(txt) document.getElementById('loading-text').innerText = txt;
    }
</script>
</body>
</html>
