<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ™ºèƒ½è¯ç®± (å®‰å…¨ç‰ˆ)</title>
    <script src="//cdn.jsdelivr.net/npm/leancloud-storage@4.15.0/dist/av-min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        :root { --primary: #10a37f; --danger: #d73a49; --warning: #d4a72c; --bg: #f0f2f5; --card: #fff; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); padding: 15px; color: #333; margin: 0; padding-bottom: 60px; }
        .container { max-width: 800px; margin: 0 auto; display: none; /* é»˜è®¤éšè—ï¼Œç™»å½•åæ˜¾ç¤º */ }
        h2 { text-align: center; color: #2c3e50; margin-bottom: 15px; }
        
        /* === ğŸ” ç™»å½•ç•Œé¢æ ·å¼ === */
        #login-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 10000; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; }
        .login-box { width: 100%; max-width: 320px; text-align: center; }
        .login-box h3 { margin-bottom: 20px; color: #333; }
        .pass-input { width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 18px; text-align: center; margin-bottom: 15px; box-sizing: border-box; outline: none; transition: 0.3s; }
        .pass-input:focus { border-color: var(--primary); }
        .login-btn { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 18px; cursor: pointer; }
        /* ====================== */

        /* ç­›é€‰åŒº */
        .filter-section { position: sticky; top: 0; background: var(--bg); z-index: 90; padding: 10px 0; }
        .search-box { position: relative; margin-bottom: 10px; }
        .search-box input { width: 100%; padding: 12px 15px 12px 40px; border: 1px solid #ddd; border-radius: 25px; font-size: 16px; box-sizing: border-box; }
        .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #999; }
        
        /* æ»šåŠ¨æŒ‰é’®ç»„ */
        .category-scroll { display: flex; overflow-x: auto; gap: 8px; padding-bottom: 5px; scrollbar-width: none; }
        .category-scroll::-webkit-scrollbar { display: none; }
        .cat-btn { white-space: nowrap; padding: 6px 14px; border-radius: 20px; border: 1px solid #ddd; background: white; color: #555; cursor: pointer; transition: 0.2s; font-size: 14px; }
        .cat-btn.active { background: var(--primary); color: white; border-color: var(--primary); font-weight: bold; }
        /* ç‰¹æ®ŠæŒ‰é’®æ ·å¼ */
        .cat-btn.danger { color: var(--danger); border-color: #ffccd1; }
        .cat-btn.danger.active { background: var(--danger); color: white; border-color: var(--danger); }
        .cat-btn.warn { color: #b78c1b; border-color: #faeac3; }
        .cat-btn.warn.active { background: var(--warning); color: white; border-color: var(--warning); }

        /* è¾“å…¥å¡ç‰‡ */
        .toggle-input-btn { width: 100%; padding: 12px; background: white; border: 1px dashed #999; color: #555; border-radius: 8px; cursor: pointer; margin-bottom: 15px; font-weight: bold; }
        .input-card { background: var(--card); padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; display: none; }
        .input-card.show { display: block; animation: slideDown 0.3s; }
        .input-group { display: flex; gap: 8px; margin-bottom: 15px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 0.9em; color: #555; }
        
        /* æŒ‰é’® */
        .btn { border: none; padding: 10px; border-radius: 6px; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-scan { background: #333; color: white; flex-shrink: 0; width: 50px; }
        .btn-ai { background: var(--primary); color: white; flex-shrink: 0; }
        .btn-save { background: #2c3e50; color: white; width: 100%; margin-top: 15px; padding: 12px; font-size: 16px; }

        /* åˆ—è¡¨å¡ç‰‡ */
        .drug-card { background: var(--card); padding: 15px; margin-bottom: 12px; border-radius: 8px; border-left: 5px solid var(--primary); position: relative; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .drug-card.expired { border-left-color: var(--danger); background: #fff5f5; }
        .drug-card.warning { border-left-color: var(--warning); background: #fffcf0; }
        .delete-btn { position: absolute; top: 10px; right: 10px; background: none; border: none; color: #ccc; font-size: 20px; cursor: pointer; }
        .card-header { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 8px; padding-right: 30px; align-items: center; }
        .badge { padding: 2px 8px; border-radius: 10px; font-size: 0.75em; background: #eee; color: #555; }
        .badge.status { color: #fff; }

        /* æ‰«ç ä¸Loading */
        #scanner-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; display: none; flex-direction: column; justify-content: center; align-items: center; }
        #reader { width: 100%; max-width: 500px; background: #000; }
        .close-scanner { position: absolute; top: 20px; right: 20px; color: white; font-size: 30px; cursor: pointer; z-index: 2001; }
        
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.85); display: none; justify-content: center; align-items: center; z-index: 1999; flex-direction: column; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<!-- ğŸ” ç™»å½•ç•Œé¢ -->
<div id="login-modal">
    <div class="login-box">
        <div style="font-size: 50px; margin-bottom: 10px;">ğŸ’Š</div>
        <h3>å®¶åº­è¯ç®±å®‰å…¨ç™»å½•</h3>
        <input type="password" id="passwordInput" class="pass-input" placeholder="è¯·è¾“å…¥å¯†ç " onkeyup="if(event.key==='Enter') checkLogin()">
        <button class="login-btn" onclick="checkLogin()">è¿›å…¥è¯ç®±</button>
        <p style="color: #999; font-size: 12px; margin-top: 15px;">è¾“å…¥æ­£ç¡®å¯†ç è‡ªåŠ¨åŒæ­¥äº‘ç«¯æ•°æ®</p>
    </div>
</div>

<!-- æ‰«ç ç•Œé¢ -->
<div id="scanner-modal">
    <div class="close-scanner" onclick="stopScanner()">Ã—</div>
    <div id="reader"></div>
    <div style="color:white; margin-top:10px">å¯¹å‡†æ¡å½¢ç </div>
</div>

<!-- Loading -->
<div id="loading-overlay">
    <div class="spinner"></div>
    <div id="loading-text">åŠ è½½ä¸­...</div>
</div>

<div class="container" id="mainApp">
    <h2>ğŸ¥ æ™ºèƒ½å®¶åº­è¯ç®±</h2>

    <!-- 1. æœç´¢ä¸ç­›é€‰åŒº -->
    <div class="filter-section">
        <div class="search-box">
            <span class="search-icon">ğŸ”</span>
            <input type="text" id="searchInput" placeholder="æœè¯åã€åŠŸèƒ½ã€æ¡ç ..." oninput="handleSearch()">
        </div>
        <div class="category-scroll">
            <!-- æ ¸å¿ƒåŠŸèƒ½æŒ‰é’® -->
            <button class="cat-btn active" onclick="filterBy('all', this)">å…¨éƒ¨</button>
            <button class="cat-btn danger" onclick="filterBy('expired', this)">âš ï¸ å·²è¿‡æœŸ</button>
            <button class="cat-btn warn" onclick="filterBy('expiring_3m', this)">â³ 3æœˆå†…è¿‡æœŸ</button>
            <!-- åˆ†ç±»æŒ‰é’® -->
            <button class="cat-btn" onclick="filterBy('æ„Ÿå†’å‘çƒ§', this)">ğŸŒ¡ï¸ æ„Ÿå†’å‘çƒ§</button>
            <button class="cat-btn" onclick="filterBy('å’³å—½å’½ç—›', this)">ğŸ˜®â€ğŸ’¨ å’³å—½</button>
            <button class="cat-btn" onclick="filterBy('è‚ èƒƒ', this)">ğŸ¥£ è‚ èƒƒ</button>
            <button class="cat-btn" onclick="filterBy('å¤–ç”¨', this)">ğŸ©¹ å¤–ç”¨</button>
            <button class="cat-btn" onclick="filterBy('å„¿ç«¥', this)">ğŸ‘¶ å„¿ç«¥</button>
            <button class="cat-btn" onclick="filterBy('è€äºº', this)">ğŸ§“ è€äºº</button>
        </div>
    </div>

    <!-- 2. å½•å…¥åŒº -->
    <button class="toggle-input-btn" onclick="toggleInputCard()">â• æ‰«ç  / æ·»åŠ è¯å“</button>
    <div class="input-card" id="inputCard">
        <div class="input-group">
            <div style="flex-grow:1"><label>åç§° / æ¡ç </label><input type="text" id="name" placeholder="åç§° æˆ– æ‰«ç "></div>
            <div style="display:flex; align-items:flex-end; gap:5px;">
                <button class="btn btn-scan" onclick="startScanner()">ğŸ“·</button>
                <button class="btn btn-ai" onclick="identifyDrug()">âœ¨ è¯†åˆ«</button>
            </div>
        </div>
        <div class="form-grid">
            <div><label>äººç¾¤</label><select id="target"><option>é€šç”¨</option><option>æˆäºº</option><option>å„¿ç«¥</option><option>è€äºº</option></select></div>
            <div><label>æ€§åˆ«</label><select id="gender"><option>é€šç”¨</option><option>ç”·æ€§</option><option>å¥³æ€§</option></select></div>
            <div><label>æœ‰æ•ˆæœŸ</label><input type="date" id="expiry"></div>
            <div><label>åº“å­˜</label><input type="text" id="quantity"></div>
            <div style="grid-column:1/-1"><label>åŠŸèƒ½</label><input type="text" id="usage"></div>
            <div style="grid-column:1/-1"><label>ç”¨æ³•</label><input type="text" id="dosage"></div>
            <div style="grid-column:1/-1"><label>æ³¨æ„</label><input type="text" id="notes" style="border-color:#ffd7d7"></div>
        </div>
        <button class="btn btn-save" onclick="addDrug()">ğŸ“¥ æ”¾å…¥è¯ç®±</button>
    </div>

    <!-- 3. åˆ—è¡¨åŒº -->
    <div id="drugList"></div>
</div>

<script>
    // ================= âš™ï¸ é…ç½®åŒºåŸŸ =================
    // âš ï¸ è¯·ä¿®æ”¹è¿™é‡Œï¼
    const USER_PASSWORD = "285925";  // è®¾ç½®ä½ çš„å®¶åº­å¯†ç 
    const LC_APP_ID = 'WebkPZV6qkXf2ILVmohQlIj7-gzGzoHsz';
    const LC_APP_KEY = 'pD4b4TdG7tEFioQBXOMbWWi6';
    const AI_API_KEY = 'sk-69074729a1fa403789c054d21d450d6f';
    // ==============================================

    let allDrugsCache = [];
    let html5QrCode;

    // --- ğŸ” ç™»å½•é€»è¾‘ ---
    function checkLogin() {
        const input = document.getElementById('passwordInput').value;
        if (input === USER_PASSWORD) {
            // å¯†ç æ­£ç¡®
            document.getElementById('login-modal').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            
            // åˆå§‹åŒ– LeanCloud å¹¶åŠ è½½æ•°æ®
            if (!LC_APP_ID.includes('AppID')) {
                AV.init({ appId: LC_APP_ID, appKey: LC_APP_KEY, serverURL: "https://ulnxpw1a.lc-cn-n1-shared.com" });
                fetchDrugs();
            } else {
                alert("è¯·å…ˆä¿®æ”¹ä»£ç é‡Œçš„ AppID å’Œ Keyï¼");
            }
        } else {
            alert("å¯†ç é”™è¯¯ï¼");
            document.getElementById('passwordInput').value = '';
        }
    }

    // --- ğŸ”„ æ•°æ®è·å– ---
    async function fetchDrugs() {
        showLoading(true, "æ­£åœ¨åŒæ­¥è¯ç®±...");
        const query = new AV.Query('Medicine');
        query.descending('createdAt');
        query.limit(1000); // è°ƒå¤§é™åˆ¶
        try {
            allDrugsCache = await query.find();
            renderList(allDrugsCache); // é»˜è®¤æ˜¾ç¤ºå…¨éƒ¨
        } catch (error) { console.error(error); alert("åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ"); }
        showLoading(false);
    }

    // --- ğŸ” ç­›é€‰é€»è¾‘ (å‡çº§ç‰ˆ) ---
    function filterBy(type, btn) {
        // UI æ›´æ–°
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
        if(btn) btn.classList.add('active');
        document.getElementById('searchInput').value = '';

        const today = new Date();
        today.setHours(0,0,0,0);

        let filtered = [];

        if (type === 'all') {
            filtered = allDrugsCache;
        } 
        else if (type === 'expired') {
            // ç­›é€‰ï¼šå·²è¿‡æœŸ (diff < 0)
            filtered = allDrugsCache.filter(d => {
                const diff = (new Date(d.get('expiry')) - today);
                return diff < 0;
            });
        } 
        else if (type === 'expiring_3m') {
            // ç­›é€‰ï¼š3ä¸ªæœˆå†…è¿‡æœŸ (0 <= diff <= 90å¤©)
            filtered = allDrugsCache.filter(d => {
                const diffTime = (new Date(d.get('expiry')) - today);
                const diffDays = Math.ceil(diffTime / 86400000);
                return diffDays >= 0 && diffDays <= 90;
            });
        } 
        else {
            // ç­›é€‰ï¼šå¸¸è§„å…³é”®è¯
            const map = {
                'æ„Ÿå†’å‘çƒ§': ['æ„Ÿå†’','çƒ§','çƒ­','æµæ„Ÿ','é¼»å¡','æ¸…ç˜Ÿ'],
                'å’³å—½å’½ç—›': ['å’³','ç—°','å’½','å–‰','è‚º'],
                'è‚ èƒƒ': ['èƒƒ','è‚ ','æ³»','æ¶ˆåŒ–','è‚š','é…¸'],
                'å¤–ç”¨': ['è†','è´´','çš®','ç—’','å–·','æ»´','ç¢˜'],
                'å„¿ç«¥': ['å„¿','å®','ç¨š'],
                'è€äºº': ['å‹','ç³–','å¿ƒ','è„‘','é’™']
            };
            const keywords = map[type] || [];
            filtered = allDrugsCache.filter(d => {
                if(type==='å„¿ç«¥' && d.get('target')==='å„¿ç«¥') return true;
                if(type==='è€äºº' && d.get('target')==='è€äºº') return true;
                const txt = (d.get('name') + d.get('usage')).toLowerCase();
                return keywords.some(k => txt.includes(k));
            });
        }

        renderList(filtered);
    }

    // æ™®é€šæœç´¢
    function handleSearch() {
        const keyword = document.getElementById('searchInput').value.toLowerCase().trim();
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
        
        const filtered = allDrugsCache.filter(d => {
            const txt = (d.get('name') + d.get('usage') + (d.get('notes')||'')).toLowerCase();
            return txt.includes(keyword);
        });
        renderList(filtered);
    }

    // --- ğŸ“„ æ¸²æŸ“åˆ—è¡¨ ---
    function renderList(drugs) {
        const listDiv = document.getElementById('drugList');
        listDiv.innerHTML = '';
        
        if(drugs.length === 0) {
            listDiv.innerHTML = '<div style="text-align:center;color:#999;margin-top:30px">æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„è¯å“</div>';
            return;
        }

        // æ’åºï¼šå…ˆçœ‹è¿‡æœŸï¼Œå†çœ‹å¿«è¿‡æœŸ
        const sorted = [...drugs].sort((a, b) => new Date(a.get('expiry')) - new Date(b.get('expiry')));

        sorted.forEach(d => {
            const status = getStatus(d.get('expiry'));
            const div = document.createElement('div');
            div.className = `drug-card ${status.code}`;
            div.innerHTML = `
                <button class="delete-btn" onclick="deleteDrug('${d.id}')">Ã—</button>
                <div class="card-header">
                    <h3 style="margin:0">${d.get('name')}</h3>
                    <span class="badge status" style="background:${status.color}">${status.text}</span>
                    <span class="badge">${d.get('target')}</span>
                </div>
                <div style="font-size:0.9em;color:#666;line-height:1.6">
                    <div>ğŸ’Š <strong>åŠŸèƒ½:</strong> ${d.get('usage')||'-'}</div>
                    <div>ğŸ¥„ <strong>ç”¨æ³•:</strong> ${d.get('dosage')||'-'}</div>
                    <div>ğŸ“¦ <strong>åº“å­˜:</strong> ${d.get('quantity')||'-'}</div>
                    ${d.get('notes') ? `<div style="color:#d73a49;background:rgba(215,58,73,0.05);padding:4px;margin-top:4px;border-radius:4px">âš ï¸ ${d.get('notes')}</div>` : ''}
                </div>
            `;
            listDiv.appendChild(div);
        });
    }

    // --- ğŸ“· æ‰«ç ä¸ AI (ä¿æŒåŠŸèƒ½) ---
    function startScanner() {
        document.getElementById('inputCard').classList.add('show');
        document.getElementById('scanner-modal').style.display = 'flex';
        html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, 
        (decodedText) => {
            stopScanner();
            document.getElementById('name').value = decodedText;
            if(navigator.vibrate) navigator.vibrate(200);
            identifyDrug();
        }).catch(err => { alert("æ— æ³•å¯åŠ¨æ‘„åƒå¤´(è¯·ä½¿ç”¨HTTPS): " + err); stopScanner(); });
    }
    function stopScanner() {
        document.getElementById('scanner-modal').style.display = 'none';
        if(html5QrCode) html5QrCode.stop().then(() => html5QrCode.clear()).catch(()=>{});
    }

    async function identifyDrug() {
        const val = document.getElementById('name').value.trim();
        if(!val) return alert("è¯·è¾“å…¥åç§°æˆ–æ‰«ç ");
        showLoading(true, "AI æ­£åœ¨è¯†åˆ«...");
        try {
            const isBar = /^\d+$/.test(val);
            const prompt = isBar ? `æ¡å½¢ç :${val}ï¼Œæ¨æµ‹è¯ååŠä¿¡æ¯` : `è¯å:${val}`;
            
            const res = await fetch("https://api.deepseek.com/v1/chat/completions", {
                method: "POST",
                headers: { "Content-Type": "application/json", "Authorization": `Bearer ${AI_API_KEY}` },
                body: JSON.stringify({
                    model: "deepseek-chat",
                    messages: [{role: "system", content: "è¿”å›JSON: name, target(æˆäºº/å„¿ç«¥/é€šç”¨), gender, usage, dosage, notes"}, {role: "user", content: prompt}],
                    temperature: 0.1
                })
            });
            const data = await res.json();
            const result = JSON.parse(data.choices[0].message.content.replace(/```json/g,'').replace(/```/g,''));
            
            if(result.name) document.getElementById('name').value = result.name;
            ['target','gender','usage','dosage','notes'].forEach(k => document.getElementById(k).value = result[k]||'');
        } catch(e) { alert("è¯†åˆ«å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥"); }
        showLoading(false);
    }

    // --- ğŸ› ï¸ å¢åˆ ä¸å·¥å…· ---
    function toggleInputCard() { document.getElementById('inputCard').classList.toggle('show'); }
    
    async function addDrug() {
        const name = document.getElementById('name').value;
        const expiry = document.getElementById('expiry').value;
        if(!name || !expiry) return alert("è¯·å¡«å†™åç§°å’Œæœ‰æ•ˆæœŸ");
        
        showLoading(true, "ä¿å­˜ä¸­...");
        const Medicine = AV.Object.extend('Medicine');
        const drug = new Medicine();
        ['name','target','gender','expiry','usage','dosage','quantity','notes'].forEach(k => drug.set(k, document.getElementById(k).value));
        await drug.save();
        
        document.querySelectorAll('input').forEach(i => i.value='');
        toggleInputCard();
        fetchDrugs();
        showLoading(false);
    }

    async function deleteDrug(id) {
        if(!confirm("ç¡®å®šåˆ é™¤å—ï¼Ÿ")) return;
        const drug = AV.Object.createWithoutData('Medicine', id);
        await drug.destroy();
        fetchDrugs();
    }

    function getStatus(d) {
        const diff = Math.ceil((new Date(d) - new Date()) / 86400000);
        if (diff < 0) return {code:'expired', text:`è¿‡æœŸ ${Math.abs(diff)} å¤©`, color:'#d73a49'};
        if (diff <= 90) return {code:'warning', text:`å‰© ${diff} å¤©`, color:'#d4a72c'}; // æ”¹ä¸º90å¤©é¢„è­¦
        return {code:'normal', text:`æœ‰æ•ˆæœŸ ${d}`, color:'#10a37f'};
    }

    function showLoading(show, txt) {
        document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none';
        if(txt) document.getElementById('loading-text').innerText = txt;
    }
</script>
</body>
</html>
